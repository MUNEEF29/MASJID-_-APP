{% extends "base.html" %}

{% block title %}New Income Entry - Masjid Accounting{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> New Income Entry</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="date" class="form-label">Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="date" name="date" required 
                                   value="{{ request.form.get('date', '') or now().strftime('%Y-%m-%d') if now is defined else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="time" class="form-label">Time <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="time" name="time" required
                                   value="{{ request.form.get('time', '') or now().strftime('%H:%M') if now is defined else '' }}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">Select Category</option>
                                {% for cat in categories %}
                                <option value="{{ cat }}" {% if request.form.get('category') == cat %}selected{% endif %}>
                                    {{ category_names[cat] }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text" id="categoryHelp"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="payment_mode" class="form-label">Payment Mode <span class="text-danger">*</span></label>
                            <select class="form-select" id="payment_mode" name="payment_mode" required>
                                <option value="">Select Payment Mode</option>
                                {% for mode in payment_modes %}
                                <option value="{{ mode }}" {% if request.form.get('payment_mode') == mode %}selected{% endif %}>
                                    {{ payment_mode_names[mode] }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="source" class="form-label">Source <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="source" name="source" required
                               value="{{ request.form.get('source', '') }}" placeholder="e.g., Friday Collection, Donation Box">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="donor_name" class="form-label">Donor Name</label>
                            <input type="text" class="form-control" id="donor_name" name="donor_name"
                                   value="{{ request.form.get('donor_name', '') }}" placeholder="Optional">
                        </div>
                        <div class="col-md-6">
                            <label for="donor_contact" class="form-label">Donor Contact</label>
                            <input type="text" class="form-control" id="donor_contact" name="donor_contact"
                                   value="{{ request.form.get('donor_contact', '') }}" placeholder="Phone or Email">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="amount" class="form-label">Amount <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" min="0.01" class="form-control" id="amount" 
                                       name="amount" required value="{{ request.form.get('amount', '') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="payment_reference" class="form-label">Payment Reference</label>
                            <input type="text" class="form-control" id="payment_reference" name="payment_reference"
                                   value="{{ request.form.get('payment_reference', '') }}" placeholder="Transaction ID, Cheque No., etc.">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description / Remarks</label>
                        <textarea class="form-control" id="description" name="description" rows="3"
                                  placeholder="Additional notes...">{{ request.form.get('description', '') }}</textarea>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-lg"></i> Create Entry
                        </button>
                        <a href="{{ url_for('income.index') }}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('category').addEventListener('change', function() {
    const helpText = document.getElementById('categoryHelp');
    const zakatCategories = ['zakat', 'fitrah'];
    if (zakatCategories.includes(this.value)) {
        helpText.innerHTML = '<span class="text-success"><i class="bi bi-info-circle"></i> This will be recorded in the Zakat Fund (ring-fenced)</span>';
    } else if (this.value === 'special_collection') {
        helpText.innerHTML = '<span class="text-info"><i class="bi bi-info-circle"></i> This will be recorded in the Amanah/Trust Fund</span>';
    } else {
        helpText.innerHTML = '';
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    if (!document.getElementById('date').value) {
        document.getElementById('date').value = now.toISOString().split('T')[0];
    }
    if (!document.getElementById('time').value) {
        document.getElementById('time').value = now.toTimeString().slice(0, 5);
    }
});
</script>
{% endblock %}
